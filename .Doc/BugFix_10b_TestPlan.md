# Тестовый план исправления багов #10b

## Обзор исправлений

**Три коммита с исправлениями:**
- `cf8703f` - Добавлена проверка `inProgramArea` в BlockUI.OnEndDrag
- `aa46156` - Удален дублированный вызов ReturnToOriginalPosition в ProgramArea.OnDrop

**Исправленные баги:**
- #10b-1: Новый блок в конце цепи выполняется дважды
- #10b-2: Визуальный snap не применяется для промежуточных соединений
- #10b-3: Палитровый блок переносится вместо копирования

---

## Тест 1: Добавление первого блока из палитры

**Предусловие:** ProgramArea пуста

**Шаги:**
1. Откройте сцену с GameScene
2. Нажмите Play
3. Перетащите **MoveForward** блок из палитры в ProgramArea
4. Отпустите блок в произвольное место

**Ожидаемый результат:**
- ✅ В ProgramArea появился новый блок MoveForward
- ✅ В палитре остался оригинальный блок MoveForward (не исчез)
- ✅ Конекторы нового блока окрашены (зеленый INPUT, красный OUTPUT)

**Консоль проверить:**
- `[DISCONNECT] MoveForward input 0` (при начале drag)
- `[DISCONNECT] MoveForward output 0` (при начале drag)
- Нет ошибок

---

## Тест 2: Добавление в конец цепи (регрессия #10b-1)

**Предусловие:** В ProgramArea есть цепь A → B

**Шаги:**
1. Убедитесь, что есть цепь MoveForward → TurnRight
2. Перетащите новый **MoveBackward** блок из палитры
3. Поднесите OUTPUT блока MoveBackward к INPUT блока TurnRight
   - Должны появиться желтые коннекторы (OUTPUT MoveBackward + INPUT TurnRight)
4. Отпустите блок

**Ожидаемый результат:**
- ✅ Результат: MoveForward → MoveBackward → TurnRight
- ✅ Визуальный feedback работал (желтые коннекторы)
- ✅ Палитра содержит оригинальный MoveBackward

**Консоль проверить:**
- `[CONNECTION OUTPUT→INPUT] MoveBackward → TurnRight` (один раз!)
- Нет дублирования соединений

**Выполнение программы:**
1. Нажмите Run
2. Проверьте логи [EXECUTE]:
   ```
   [EXECUTE] Robot executing: MoveForward
   [EXECUTE] Robot executing: MoveBackward
   [EXECUTE] Robot executing: TurnRight
   [PROGRAM COMPLETE]
   ```
3. ✅ Каждая команда выполнена **ОДИН раз** (не дважды!)

---

## Тест 3: Визуальный snap к промежуточным точкам (регрессия #10b-2)

**Предусловие:** В ProgramArea есть цепь A → B → C

**Шаги:**
1. Убедитесь, что есть MoveForward → TurnLeft → TurnRight
2. Перетащите новый **MoveBackward** блок из палитры
3. Поднесите **OUTPUT** MoveBackward к **INPUT** TurnLeft (промежуточное соединение)
   - Должны появиться желтые коннекторы

**Ожидаемый результат:**
- ✅ Визуальный feedback работает (OUTPUT MoveBackward желтый, INPUT TurnLeft желтый)
- ✅ При отпускании snap применяется

**Консоль проверить:**
- `[SNAP READY OUTPUT→INPUT]` должно быть видно при близости
- Снеп успешно применен

**Выполнение программы:**
- ✅ Цепь: MoveForward → MoveBackward → TurnLeft → TurnRight

---

## Тест 4: Вставка в середину цепи

**Предусловие:** В ProgramArea есть цепь A → B → C

**Шаги:**
1. Создайте цепь MoveForward → TurnLeft → TurnRight
2. Перетащите новый **MoveBackward** блок из палитры
3. Поднесите OUTPUT MoveBackward между TurnLeft и TurnRight (к INPUT TurnRight)
4. Отпустите блок

**Ожидаемый результат:**
- ✅ Результат: MoveForward → TurnLeft → MoveBackward → TurnRight
- ✅ Логи показывают переконектирование:
  ```
  [DISCONNECT FOR INSERT] TurnLeft → TurnRight
  [RECONNECT] TurnLeft → MoveBackward
  [CONNECTION OUTPUT→INPUT] MoveBackward → TurnRight
  ```

**Выполнение программы:**
1. Нажмите Run
2. ✅ Выполнение в порядке: MoveForward → TurnLeft → MoveBackward → TurnRight

---

## Тест 5: Перемещение существующего блока (регрессия)

**Предусловие:** В ProgramArea есть цепь A → B → C

**Шаги:**
1. Создайте цепь MoveForward → TurnLeft → TurnRight
2. Перетащите **существующий** блок TurnRight (УЖЕ в программе!)
3. Поднесите OUTPUT TurnRight к INPUT MoveForward (в начало)
4. Отпустите блок

**Ожидаемый результат:**
- ✅ Результат: TurnRight → MoveForward → TurnLeft
- ✅ Входящее соединение (от TurnLeft) было разорвано
- ✅ Логи:
  ```
  [DISCONNECT INCOMING] TurnLeft → TurnRight
  [DISCONNECT] TurnRight output 0
  [CONNECTION OUTPUT→INPUT] TurnRight → MoveForward
  ```

**Выполнение программы:**
- ✅ Выполнение в новом порядке

---

## Тест 6: Палитра сохраняет оригинальные блоки

**Предусловие:** Палитра видна

**Шаги:**
1. Перетащите MoveForward из палитры в ProgramArea
2. Отпустите блок в произвольное место
3. Проверьте палитру - должен быть оригинальный MoveForward
4. Повторите 5 раз с разными блоками (MoveBackward, TurnLeft, TurnRight)

**Ожидаемый результат:**
- ✅ Палитра всегда содержит все 4 оригинальных блока
- ✅ Не исчезли при перетаскивании
- ✅ Можно перетащить одну копию несколько раз подряд

---

## Критерии успеха

Все тесты должны пройти без ошибок:

- [ ] Тест 1: Первый блок добавляется и палитра сохраняется
- [ ] Тест 2: Блок в конце выполняется один раз
- [ ] Тест 3: Визуальный snap работает для всех точек
- [ ] Тест 4: Вставка в середину с переконектированием
- [ ] Тест 5: Перемещение существующего блока работает
- [ ] Тест 6: Палитра сохраняет все блоки

**Дополнительная проверка:**
- Нет ошибок в консоли
- Debug логи показывают корректные соединения
- Программа выполняется в правильном порядке

---

## Заметки для отладки

Если что-то не работает, проверьте логи консоли:

**Должны быть:**
- `[CONNECTION ...]` - соединения созданы корректно
- `[DISCONNECT ...]` - разрывы соединений при необходимости
- `[SNAP APPLIED ...]` - снепы применены

**Не должны быть:**
- Дублированные `[CONNECTION ...]` логи
- `Null reference exceptions`
- `ArgumentOutOfRangeException`

**Если палитра потеряла блок:**
- Перезагрузите сцену
- Проверьте, что BlockFactory создает копии, а не переносит оригиналы

---

## Результаты тестирования

**Дата:** [заполнить после тестирования]
**Тестировщик:** [заполнить]

**Статус:** ⬜ Не тестировано / ✅ Все тесты прошли / ❌ Найдены проблемы

**Найденные проблемы:**
- ...

**Заметки:**
- ...
