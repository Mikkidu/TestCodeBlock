# #11 Блок цикла

## Goal
Создать блок цикла с поддержкой вложенных блоков. Цикл должен уметь выполнять вложенные блоки нужное количество раз, затем переходить к следующему блоку в цепи.

**Визуальное представление:**
```
┌─ LOOP (2 раза) ────┐
│                    │
│  [Forward]  [Turn] │  ← блоки внутри цикла
│                    │
└────────────────────┘
        ↓
    [Forward]  ← блок после цикла
```

## Context
- Есть система выполнения commands через Promise chains
- Блоки подключаются через snap (вход→выход)
- Нужно создать иерархию: цикл содержит блоки, а цикл содержится в основной цепи

## Key Steps

1. **Создать класс LoopCommand (Core)**
   - Наследовать от BaseCommand (или ICommand)
   - Добавить поле `List<ICommand> innerCommands` для вложенных команд
   - Добавить поле `int repeatCount` (можно начать с константы, потом параметром)
   - В Execute() вызвать внутренние команды в цикле

2. **Создать LoopBlockUI (UI)**
   - Визуальный блок с двумя OUTPUT'ами:
     - Input connector (вход цикла)
     - Output connector (выход из цикла, к следующему блоку)
     - Inner area: прямоугольная область внутри блока для вложенных блоков
   - Визуально отличаться от обычных блоков (скругленные углы, полупрозрачная область внутри)

3. **Создать LoopProgramArea (UI)**
   - Компонент IDropHandler для области внутри цикла
   - Принимает блоки также как основной ProgramArea
   - Управляет списком innerCommands в LoopCommand
   - Имеет собственный SnapManager? Или переиспользует общий?

4. **Реализовать логику исполнения цикла**
   - LoopCommand.Execute() вызывает методы внутренних блоков в цикле
   - После завершения цикла возвращает Promise, чтобы цепь продолжилась дальше
   - Поддерживает Promise-цепи внутри цикла (как основная цепь)

5. **Добавить LoopBlock в BlockPalette**
   - Зарегистрировать CommandType.Loop
   - Добавить визуальное представление в палитре

6. **Тестирование**
   - Перетащить Loop из палитры
   - Перетащить 2-3 блока внутрь Loop
   - Перетащить блок после Loop
   - Запустить программу
   - Проверить логи [EXECUTE] что блоки внутри цикла выполняются нужное количество раз

## Acceptance Criteria
- [ ] LoopCommand создан и поддерживает innerCommands
- [ ] LoopBlockUI имеет визуальную область для вложенных блоков
- [ ] Блоки можно перетащить внутрь Loop (snap работает внутри)
- [ ] Цикл выполняется нужное количество раз
- [ ] Блоки после цикла выполняются после завершения цикла
- [ ] Debug логи показывают [LOOP START], [LOOP END] и счетчик итераций

## Blockers & Risks
- Нужно решить: может ли цикл содержать другие циклы (вложенные циклы)?
- Нужно решить: как представить repeat count в UI (для начала константа, потом параметр в #12)
- Возможные проблемы с переконектированием цепи через цикл
- Тестирование Promise chains внутри цикла

## Notes
- Для начала можно hardcode repeat count = 2
- Потом будет параметр для выбора count (задача #12)
- Внутренняя область может быть отдельной сценой/Canvas или просто прямоугольником внутри блока
- Можно сделать свертывание/развертывание цикла (collapse/expand)
